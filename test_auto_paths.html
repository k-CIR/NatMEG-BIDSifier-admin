<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auto Path Updates</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .test-result { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        .pass { background: #d4edda; border-left: 4px solid #28a745; }
        .fail { background: #f8d7da; border-left: 4px solid #dc3545; }
        input { width: 300px; padding: 8px; margin: 5px 0; display: block; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        button { padding: 8px 16px; margin: 10px 0; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Automatic Path Updates - Test Suite</h1>
    
    <div class="test-section">
        <h2>Form Fields</h2>
        <label>Root Path:</label>
        <input id="config_root_path" placeholder="/home/data" value="">
        
        <label>Project Name:</label>
        <input id="config_project_name" placeholder="MyStudy" value="">
        
        <label>Raw Data Path (Auto):</label>
        <input id="config_raw_path" placeholder="Auto-filled" value="" disabled>
        
        <label>BIDS Output Path (Auto):</label>
        <input id="config_bids_path" placeholder="Auto-filled" value="" disabled>
    </div>

    <div class="test-section">
        <h2>Manual Tests</h2>
        <button onclick="runTest1()">Test 1: Basic Auto-Fill</button>
        <button onclick="runTest2()">Test 2: Manual Edit Prevention</button>
        <button onclick="runTest3()">Test 3: Trailing Slash Handling</button>
        <button onclick="runTest4()">Test 4: Reset on Load</button>
        <button onclick="clearAll()">Clear All</button>
    </div>

    <div id="results"></div>

    <script>
        // Minimal implementation for testing
        let rawPathManuallyEdited = false;
        let bidsPathManuallyEdited = false;

        const rawPathEl = document.getElementById('config_raw_path');
        const bidsPathEl = document.getElementById('config_bids_path');
        const rootPathEl = document.getElementById('config_root_path');
        const projectNameEl = document.getElementById('config_project_name');

        // Mark paths as manually edited
        if (rawPathEl) {
            rawPathEl.addEventListener('input', () => {
                if (rawPathEl.value.trim()) {
                    rawPathManuallyEdited = true;
                }
            });
        }
        if (bidsPathEl) {
            bidsPathEl.addEventListener('input', () => {
                if (bidsPathEl.value.trim()) {
                    bidsPathManuallyEdited = true;
                }
            });
        }

        // Function to update paths automatically
        function updateAutomaticPaths() {
            const root = rootPathEl ? rootPathEl.value.trim() : '';
            const projectName = projectNameEl ? projectNameEl.value.trim() : '';
            const cleanRoot = root.replace(/\/$/, '');

            if (!rawPathManuallyEdited && rawPathEl) {
                if (cleanRoot && projectName) {
                    rawPathEl.value = cleanRoot + '/' + projectName + '/raw';
                } else {
                    rawPathEl.value = '';
                }
            }

            if (!bidsPathManuallyEdited && bidsPathEl) {
                if (cleanRoot && projectName) {
                    bidsPathEl.value = cleanRoot + '/' + projectName + '/BIDS';
                } else {
                    bidsPathEl.value = '';
                }
            }
        }

        // Attach listeners
        if (rootPathEl) {
            rootPathEl.addEventListener('input', updateAutomaticPaths);
        }
        if (projectNameEl) {
            projectNameEl.addEventListener('input', updateAutomaticPaths);
        }

        // Test functions
        function addResult(testName, passed, details) {
            const resultsDiv = document.getElementById('results');
            const result = document.createElement('div');
            result.className = `test-result ${passed ? 'pass' : 'fail'}`;
            result.innerHTML = `<strong>${testName}</strong>: ${passed ? '✓ PASSED' : '✗ FAILED'}<br>${details}`;
            resultsDiv.appendChild(result);
        }

        function runTest1() {
            clearAll();
            rootPathEl.value = '/home/data';
            projectNameEl.value = 'MyStudy';
            updateAutomaticPaths();
            
            const rawMatch = rawPathEl.value === '/home/data/MyStudy/raw';
            const bidsMatch = bidsPathEl.value === '/home/data/MyStudy/BIDS';
            
            addResult('Test 1: Basic Auto-Fill', rawMatch && bidsMatch, 
                `Raw: ${rawPathEl.value} (expected: /home/data/MyStudy/raw)<br>BIDS: ${bidsPathEl.value} (expected: /home/data/MyStudy/BIDS)`);
        }

        function runTest2() {
            clearAll();
            
            // User manually edits raw path
            rawPathEl.disabled = false;
            rawPathEl.value = '/custom/path';
            rawPathEl.disabled = true;
            rawPathManuallyEdited = true;
            
            // Now try auto-update
            rootPathEl.value = '/home/data';
            projectNameEl.value = 'MyStudy';
            updateAutomaticPaths();
            
            const rawNotOverwritten = rawPathEl.value === '/custom/path';
            const bidsUpdated = bidsPathEl.value === '/home/data/MyStudy/BIDS';
            
            addResult('Test 2: Manual Edit Prevention', rawNotOverwritten && bidsUpdated,
                `Raw path preserved: ${rawPathEl.value} (should stay /custom/path)<br>BIDS path auto-updated: ${bidsPathEl.value} (should be /home/data/MyStudy/BIDS)`);
        }

        function runTest3() {
            clearAll();
            rootPathEl.value = '/home/data/'; // With trailing slash
            projectNameEl.value = 'MyStudy';
            updateAutomaticPaths();
            
            const noDoubleSlash = !rawPathEl.value.includes('//') && !bidsPathEl.value.includes('//');
            const rawCorrect = rawPathEl.value === '/home/data/MyStudy/raw';
            const bidsCorrect = bidsPathEl.value === '/home/data/MyStudy/BIDS';
            
            addResult('Test 3: Trailing Slash Handling', noDoubleSlash && rawCorrect && bidsCorrect,
                `Raw: ${rawPathEl.value} (should be /home/data/MyStudy/raw)<br>BIDS: ${bidsPathEl.value} (should be /home/data/MyStudy/BIDS)`);
        }

        function runTest4() {
            clearAll();
            
            // Simulate manual edits
            rawPathManuallyEdited = true;
            bidsPathManuallyEdited = true;
            rawPathEl.disabled = false;
            bidsPathEl.disabled = false;
            rawPathEl.value = '/custom/raw';
            bidsPathEl.value = '/custom/bids';
            
            // Simulate loading (reset flags)
            rawPathManuallyEdited = false;
            bidsPathManuallyEdited = false;
            
            // Now auto-update should work
            rootPathEl.value = '/home/data';
            projectNameEl.value = 'NewStudy';
            updateAutomaticPaths();
            
            const rawReset = rawPathEl.value === '/home/data/NewStudy/raw';
            const bidsReset = bidsPathEl.value === '/home/data/NewStudy/BIDS';
            
            addResult('Test 4: Reset on Load', rawReset && bidsReset,
                `Raw: ${rawPathEl.value} (expected: /home/data/NewStudy/raw)<br>BIDS: ${bidsPathEl.value} (expected: /home/data/NewStudy/BIDS)`);
        }

        function clearAll() {
            rootPathEl.value = '';
            projectNameEl.value = '';
            rawPathEl.value = '';
            bidsPathEl.value = '';
            rawPathManuallyEdited = false;
            bidsPathManuallyEdited = false;
            rawPathEl.disabled = true;
            bidsPathEl.disabled = true;
        }
    </script>
</body>
</html>
