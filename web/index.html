<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NatMEG-BIDSifier ‚Äî Web UI</title>
    <link rel="stylesheet" href="/styles.css?v=2">
  </head>
  <body>
    <div class="app-container">
      <aside class="sidebar">
        <div class="app-title">NatMEG-BIDSifier</div>
        <div class="brand-logos">
          <img src="/NatMEG_logo.png" alt="NatMEG" />
          <img src="/CIR_logo.png" alt="CIR" />
        </div>
        <div class="nav-items">
          <div class="nav-section">
            <div class="nav-item active" data-view="main-config" data-step="1">
              <span class="step-number">1</span>
              <span class="step-label">Configuration</span>
            </div>
            <div class="nav-item" data-view="main-editor" data-step="2">
              <span class="step-number">2</span>
              <span class="step-label">Analyse / Editor</span>
            </div>
          </div>

          <div class="nav-section">
            <div class="nav-item" data-view="main-execute" data-step="3">
              <span class="step-number">3</span>
              <span class="step-label">Execute</span>
            </div>
          </div>

          <div class="nav-section">
            <div class="nav-item" data-view="main-report" data-step="4">
              <span class="step-number">4</span>
              <span class="step-label">Results</span>
            </div>
          </div>
        </div>
        <div class="sidebar-footer">
          <a class="github-link" href="https://github.com/k-CIR/NatMEG-BIDSifier" target="_blank">GitHub</a>
        </div>
      </aside>
      <main class="main-content">
        <div class="container">
          <!-- small badge to help debugging which view is active -->
          <div id="activeViewBadge" class="active-view-badge">view: main-config</div>
          <div class="header-bar">
            <div>
              <h1>NatMEG-BIDSifier ‚Äî Web UI</h1>
              <div class="subtitle">Edit your config, preview conversion tables and run conversions ‚Äî lightweight web interface for the server.</div>
            </div>
            <div class="header-actions">
              <!-- Connection badge updates live (see web/app.js) -->
              <div id="connectionBadge" class="connection-badge disconnected" role="status" aria-live="polite">
                <span id="connectionDot" class="connection-dot" aria-hidden="true"></span>
                <small id="connectionText" class="connection-text">Disconnected</small>
              </div>
            </div>
          </div>

          <!-- upload controls visible only on the Configuration view (moved into main-config) -->

          <div id="main-config" class="main-view">
            <h3>Configuration</h3>

            <div style="display:flex; gap:16px; align-items:flex-start; width:100%;">
              <!-- Server section spans both columns -->
              <div class="form-section" style="flex:1;">
                <div style="font-weight:700; margin-bottom:8px;">Config file</div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <input id="loadConfigPath" placeholder="server path to load config file" class="input-wide-compact" style="flex:1">
                  <button type="button" class="btn btn-browse" onclick="FileBrowser.open('loadConfigPath')" style="margin:0;">üìÅ Browse</button>
                  <button id="loadConfigBtn" class="btn">Load</button>
                  <button id="saveConfigBtn" class="btn primary" disabled>üíæ Save</button>
                  <div id="configSaveState" class="muted" style="margin-left:6px">saved</div>
                  <!-- <button id="reloadConfigBtn" class="btn">Reload</button> -->
                </div>
              </div>
            </div>

            <div style="display:flex; gap:16px; align-items:flex-start; width:100%;">
              <!-- Left column: form fields -->
              <div style="flex:1 1 420px;">

                <div class="form-section">
                  <h4>Project settings</h4>
                  <small class="hint">Basic project identification and tasks used to generate conversion mappings.</small>
                  <div style="display:flex; gap:8px; align-items:flex-start;">
                    <div class="form-group" style="flex:1;">
                      <label>Project Name</label>
                      <input id="config_project_name" class="input-text" placeholder="My Study">
                    </div>
                    <div class="form-group" style="flex:1;">
                      <label>CIR ID</label>
                      <input id="config_cir_id" class="input-text" placeholder="Optional CIR identifier">
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Tasks <small style="color: var(--muted); font-weight:400">(comma-separated)</small></label>
                    <input id="config_tasks" class="input-text" placeholder="TaskA, TaskB">
                  </div>
                </div>

            <div class="form-section">
              <h4>Paths</h4>
              <small class="hint">Filesystem locations used by the conversion (root, raw data and outputs).</small>
              <div class="form-group">
                <label>Project's root <small style="color: var(--muted); font-weight:400">Absolute path</small></label>
                <div style="display:flex; gap:8px;"><input id="config_root_path" class="input-wide-compact"><button type="button" class="btn btn-browse" onclick="FileBrowser.open('config_root_path')">üìÅ Browse</button></div>
              </div>
              <div class="form-group">
                <label>Raw Data Folder</label>
                <div style="display:flex; gap:8px;"><input id="config_raw_path" class="input-wide-compact"><button type="button" class="btn btn-browse" onclick="FileBrowser.open('config_raw_path')">üìÅ Browse</button></div>
              </div>
              <div class="form-group">
                <label>BIDS Output Folder</label>
                <div style="display:flex; gap:8px;"><input id="config_bids_path" class="input-wide-compact"><button type="button" class="btn btn-browse" onclick="FileBrowser.open('config_bids_path')">üìÅ Browse</button></div>
              </div>
              <div class="form-group">
                <label>Calibration file</label>
                <div style="display:flex; gap:8px;"><input id="config_calibration_path" class="input-text"><button type="button" class="btn btn-browse" onclick="FileBrowser.open('config_calibration_path')">üìÅ Browse</button></div>
              </div>
              <div class="form-group">
                <label>Crosstalk file</label>
                <div style="display:flex; gap:8px;"><input id="config_crosstalk_path" class="input-text"><button type="button" class="btn btn-browse" onclick="FileBrowser.open('config_crosstalk_path')">üìÅ Browse</button></div>
              </div>
            </div>
  
          </div>
          <!-- Right column: YAML editor + dataset metadata (save controls are part of server section above) -->
          <div class="form-section" style="flex:1 1 520px; display:flex; flex-direction:column; gap:8px;">
            <div style="display:flex; gap:8px; align-items:center;">
              <div style="flex:1 1 260px; display:flex; gap:8px; align-items:center;">
                <div style="flex:1">
                  <h4>BIDS dataset metadata</h4>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <input id="config_dataset_description_file" class="input-wide-compact" value="dataset_description.json" style="width:260px">
                  <button id="saveDatasetDescBtn" class="btn" title="Save dataset_description.json">Save JSON</button>
                </div>
              </div>
            </div>
            <small class="hint">Information in <code>dataset_description.json</code> and other metadata fields. (In BIDS folder)</small>

            <div style="display:flex; gap:8px; align-items:center;">
              <div class="form-group">
                <label>Dataset Name</label>
                <input id="config_dataset_name" class="input-text" placeholder="My MEG Study">
              </div>
              <div class="form-group">
                <label>BIDS Version</label>
                <input id="config_bids_version" class="input-text" value="1.7.0">
              </div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <div class="form-group">
                <label>Dataset type</label>
                <select id="config_dataset_type" class="input-wide-compact">
                  <option value="raw">raw</option>
                  <option value="derivative">derivative</option>
                </select>
              </div>
              <div class="form-group">
                <label>License</label>
                <input id="config_license" class="input-text" placeholder="CC0, CC-BY-4.0">
              </div>
            </div>
            <div class="form-group">
              <label>Authors (comma-separated)</label>
              <input id="config_authors" class="input-text" placeholder="Jane Doe, John Smith">
            </div>
              <!-- YAML editor removed: configuration loads directly into the form fields -->

            <div class="form-group">
              <label>Acknowledgements</label>
              <textarea id="config_acknowledgements" class="input-text" placeholder="Acknowledgements..." rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>How to Acknowledge</label>
              <textarea id="config_how_to_acknowledge" class="input-text" placeholder="Please cite..." rows="2"></textarea>
            </div>
            <div class="form-group">
              <label>Funding (comma-separated)</label>
              <input id="config_funding" class="input-text" placeholder="Grant 123456, Foundation XYZ">
            </div>
            <div class="form-group">
              <label>Ethics Approvals (comma-separated)</label>
              <input id="config_ethics_approvals" class="input-text" placeholder="IRB-2024-001">
            </div>
            <div class="form-group">
              <label>References and Links (comma-separated URLs)</label>
              <input id="config_references_links" class="input-text" placeholder="https://example.com/study">
            </div>
            <div style="display:flex; gap:8px; margin-top:6px;">
              <div class="form-group">
                <label>Dataset DOI</label>
                <input id="config_dataset_doi" class="input-text" placeholder="doi:10.1234/example">
              </div>
              <div class="form-group">
                <label>Code URL</label>
                <input id="config_code_url" class="input-text" value="https://mne.tools/mne-bids/">
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- EDITOR -->
      <div id="main-editor" class="main-view view-hidden">
        <div id="tableEditor" style="margin-top:0;">
          <h3>Conversion Table Editor</h3>


          <!-- Editor action row: Analyze (primary), download, close, load, reload, save -->
          <div style="margin-bottom:10px; display:flex; gap:8px; align-items:center; flex-wrap:nowrap;">
            <!-- desired order: Analyse, Load Table, path input, Save Changes, Overwrite -->
             <div style="display:flex; gap:6px; align-items:center; white-space:nowrap;">
              <label for="config_overwrite" style="cursor:pointer; margin:0; font-size:14px;">Overwrite</label>
              <input type="checkbox" id="config_overwrite" style="cursor:pointer; width:18px; height:18px;">
            </div>
            <button id="analyzeBtn" class="btn primary">Analyse</button>
            <button id="loadTableBtn" class="btn">Load</button>
            <!-- path to the currently loaded conversion table (editable) -->
              <!-- flexible path input group: grows to take the available horizontal space -->
              <div style="display:flex; align-items:center; gap:6px; flex:1; min-width:0;">
                <input id="saveTablePath" class="input-text" placeholder="Path to table (edit to save as...)" style="min-width:0; width:100%;">
                <button type="button" class="btn btn-browse" onclick="FileBrowser.open('saveTablePath')" title="Browse for path" style="margin:0;">üìÅ Browse</button>
                <button id="reloadEditorBtn" class="btn btn-icon" disabled title="Reload table" aria-label="Reload">
                  <!-- Inline compact SVG glyph (monochrome, uses currentColor) -->
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" aria-hidden="true" focusable="false">
                    <path d="M12 6V2L8 6l4 4V8c2.76 0 5 2.24 5 5 0 1.03-.31 1.99-.84 2.79l1.46 1.46C18.68 15.1 19 13.59 19 12c0-3.87-3.13-7-7-7zM6.84 7.21C6.32 8.01 6 8.97 6 10c0 3.87 3.13 7 7 7v4l4-4-4-4v3c-2.76 0-5-2.24-5-5 0-1.03.31-1.99.84-2.79z" />
                  </svg>
                </button>
              </div>
            <button id="saveTableServer" class="btn primary" disabled>üíæ Save</button>
          </div>

          <!-- Search / summary / batch actions -->
          <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
            <div id="batchActionsDiv" style="display:none; gap:10px; align-items:center;">
              <div id="selectedCount">0 rows selected</div>
              <select id="batchStatusSelect" class="input-sm">
                <option value="">-- Change Status --</option>
                <option value="run">run</option>
                <option value="check">check</option>
                <option value="processed">processed</option>
                <option value="skip">skip</option>
              </select>
              <button id="applyBatchStatusBtn" class="btn" disabled>Apply to Selected</button>
            </div>
            <div class="flex-1"></div>
              <input id="editorSearchInput" placeholder="üîç Search all fields..." class="input-wide-compact" style="min-width:260px">
              <!-- hidden file picker for loading a local TSV into the editor -->
              <input id="loadTableInput" type="file" accept=".tsv,.txt" style="display:none" aria-hidden="true">
              <select id="statusFilterSelect" class="input-sm" aria-label="Filter status" style="min-width:100px;">
                <option value="">All Status</option>
                <option value="check">check</option>
                <option value="run">run</option>
                <option value="processed">processed</option>
                <option value="skip">skip</option>
              </select>
              <select id="subjectFilterSelect" class="input-sm" aria-label="Filter subjects" style="min-width:120px;">
                <option value="">All Subjects</option>
              </select>
              <select id="sessionFilterSelect" class="input-sm" aria-label="Filter sessions" style="min-width:120px;">
                <option value="">All Sessions</option>
              </select>
              <select id="taskFilterSelect" class="input-sm" aria-label="Filter tasks" style="min-width:160px;">
                <option value="">All Tasks</option>
              </select>
              <select id="acquisitionFilterSelect" class="input-sm" aria-label="Filter acquisition" style="min-width:120px;">
                <option value="">All Acquisitions</option>
              </select>
              <!-- <div id="editorRowCount" class="muted">No data loaded</div> -->
          </div>

          <div id="tableContainer" style="overflow:auto; border:1px solid #eee; max-height:360px"></div>
          <div>
            <small class="hint">‚ùó Only first split of split files are shown in the table</small>
          </div>
          <div class="card" style="margin-top:14px">
            <h3 style="margin-top:0">Output</h3>
          <div style="display:flex; justify-content:space-between; gap:8px; align-items:center">
            <div id="editorProgressContainer" class="progress-container" style="flex:1">
            <div class="progress">
              <div id="editorProgressBar" class="bar"></div>
            </div>
            <div id="editorProgressText" class="muted" style="margin-top:6px">Idle</div>
            </div>
            <div style="margin-left:8px">
              <button id="editorStopBtn" class="btn warn" disabled>‚ñ† Stop</button>
            </div>
          </div>
          <pre id="output" class="console-output small">‚Äî</pre>
          <div id="artifacts" class="artifacts" style="margin-top:12px"></div>
        </div>
        
        </div>
      </div>

      <!-- action-row moved into Execute view so Editor remains focused on editing -->

      <div id="main-execute" class="main-view view-hidden">
        <h3>Execute</h3>
        <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
          <button id="runBtn" class="btn primary">‚ñ∂ Run</button>
        <div class="flex-1"></div>
        <div id="status" class="muted">Ready</div>
      </div>

        <div class="card" style="margin-top:14px">
          <h3 style="margin-top:0">Output</h3>
          <div style="display:flex; justify-content:space-between; gap:8px; align-items:center">
            <div id="executeProgressContainer" class="progress-container" style="flex:1">
            <div class="progress">
              <div id="executeProgressBar" class="bar"></div>
            </div>
            <div id="executeProgressText" class="muted" style="margin-top:6px">Idle</div>
            </div>
            <div style="margin-left:8px">
              <button id="executeStopBtn" class="btn warn" disabled>‚ñ† Stop</button>
            </div>
          </div>
          <pre id="output" class="console-output small">‚Äî</pre>
          <div id="artifacts" class="artifacts" style="margin-top:12px"></div>
        </div>
        <!-- <div id="artifacts" style="margin-top:12px"></div> -->
      </div>

      <div id="main-report" class="main-view view-hidden">
        <h3>Results</h3>
        <div style="display:flex; gap:10px; align-items:center; margin-top:8px;"></div>
          <button id="reportBtn" class="btn">üìä Report</button>
           <button id="loadBidsBrowserBtn" class="btn">Load BIDS Browser</button>
        <div class="flex-1"></div>
        
        <div class="card" style="margin-top:14px">
          <div style="display:flex; justify-content:space-between; gap:8px; align-items:center">
            <div id="reportProgressContainer" class="progress-container" style="flex:1">
              <div class="progress">
                <div id="reportProgressBar" class="bar"></div>
              </div>
              <div id="reportProgressText" class="muted" style="margin-top:6px">Idle</div>
            </div>
          </div>

          <div style="display:flex; gap:12px; margin-top:12px; align-items:flex-start;">
            <div style="flex: 1 1 800px; min-width:320px;">
              <h4>Summary</h4>
              <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
                <div style="padding:10px; border-radius:6px; border:1px solid #eee; text-align:center;">
                  <div style="font-size:22px; font-weight:700" id="stat-subjects">0</div>
                  <div style="color:#666; font-size:12px">Subjects</div>
                </div>
                <div style="padding:10px; border-radius:6px; border:1px solid #eee; text-align:center;">
                  <div style="font-size:22px; font-weight:700" id="stat-sessions">0</div>
                  <div style="color:#666; font-size:12px">Sessions</div>
                </div>
                <div style="padding:10px; border-radius:6px; border:1px solid #eee; text-align:center;">
                  <div style="font-size:22px; font-weight:700" id="stat-tasks">0</div>
                  <div style="color:#666; font-size:12px">Tasks processed</div>
                </div>
              </div>

              <h4 style="margin-top:12px">BIDS Browser</h4>
              <div id="bidsBrowserContainer" style="border:1px solid #eee; border-radius:6px; background:#fafafa; display:flex; flex-direction:column; min-height:400px; padding: 12px; overflow: auto;">
                <div style="color: #999; font-size: 13px; text-align: center;">Click "Load BIDS Browser" to browse BIDS directory</div>
              </div>
              
              <style>
                .bids-item:hover {
                  background-color: #f0f7ff !important;
                }
              </style>
              
              <!-- Load external BIDS Browser module -->
              <script src="app-bids-browser.js"></script>
              
              <!-- Attach button handler -->
              <script>
                (function() {
                  var loadBtn = document.getElementById('loadBidsBrowserBtn');
                  if (!loadBtn || !window.BIDSBrowser) return;
                  
                  loadBtn.addEventListener('click', function() {
                    var configBidsPathEl = document.getElementById('config_bids_path');
                    var bidsPath = (configBidsPathEl ? configBidsPathEl.value : '').trim();
                    
                    // Use test path if none configured
                    if (!bidsPath) {
                      bidsPath = '~/data/OPM-benchmarking/BIDS/';
                    }
                    
                    if (window.BIDSBrowser && typeof window.BIDSBrowser.loadDirectory === 'function') {
                      window.BIDSBrowser.loadDirectory(bidsPath);
                    }
                  });
                })();
              </script>
            </div>

            <!-- <div style="flex: 1 1 420px; min-width:360px;">
              <h4>Console</h4>
              <pre id="reportOutput" class="console-output small">‚Äî</pre>

              <h4 style="margin-top:12px">Report View</h4>
              <div id="reportArea">No report yet ‚Äî run Analyse or Report to generate output</div>
            </div> -->
          </div>
        </div>
      </div>

      </main>
    </div>

    <!-- Save As modal (hidden by default) -->
    <div id="saveAsModal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="saveAsTitle">
        <h3 id="saveAsTitle">Save configuration</h3>
        <p class="hint">Choose a path to save the config. To keep the current file, leave as-is; to create a new file, edit the path.</p>
        <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
          <input id="saveAsInput" class="input-wide-compact" placeholder="configs/myconfig.yml" />
        </div>
        <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
          <button id="saveAsCancel" class="btn">Cancel</button>
          <button id="saveAsConfirm" class="btn primary">Save</button>
        </div>
      </div>
    </div>
    <script src="/editor-model.js"></script>
    <script src="/app-filebrowser.js"></script>
    <script src="/app-report.js"></script>
    <script src="/app-config.js"></script>
    <script src="/app-editor.js"></script>
    <script src="/app.js"></script>
    <script src="/app-jobs.js"></script>
  </div>
  </body>
</html>
